#!/bin/bash
# Pre-commit hook to prevent accidental commit of copyrighted materials
# Part of the rule-based-horror-generator copyright protection system
# See DATA_POLICY.md for complete policy

set -e

echo "üîç Copyright Protection Check - Scanning staged files..."
echo ""

# Colors for output (if terminal supports it)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if we found any violations
VIOLATIONS_FOUND=0

# Patterns that should NEVER be committed
# Each pattern is checked against staged file paths
FORBIDDEN_PATTERNS=(
    "data_private/"
    "**/data_private/"
    "transcripts/"
    "**/transcripts/"
    "*.srt"
    "*.vtt"
    "*.sbv"
    "*_transcript.csv"
    "*_transcripts.csv"
    "transcript_*.csv"
    "transcripts_*.csv"
    "copyrighted_examples/"
    "third_party_texts/"
    "reference_materials/"
    "source_materials/"
    "story_corpus/"
    "story_corpora/"
)

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No files staged for commit${NC}"
    exit 0
fi

echo "Checking $(echo "$STAGED_FILES" | wc -l) staged file(s)..."
echo ""

# Check each forbidden pattern
for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    # Convert glob pattern to grep-compatible regex
    # Escape special characters and convert globs
    grep_pattern=$(echo "$pattern" | sed 's/\*\*/.*/g' | sed 's/\*/[^\/]*/g' | sed 's/\./\\./g')

    # Check if any staged files match this pattern
    matches=$(echo "$STAGED_FILES" | grep -E "$grep_pattern" || true)

    if [ -n "$matches" ]; then
        if [ $VIOLATIONS_FOUND -eq 0 ]; then
            echo "${RED}‚ùå COMMIT BLOCKED - Forbidden file patterns detected${NC}"
            echo ""
            echo "The following files match protected patterns and contain copyrighted material:"
            echo ""
        fi

        echo "${RED}Pattern: $pattern${NC}"
        echo "$matches" | sed 's/^/  ‚Üí /'
        echo ""

        VIOLATIONS_FOUND=1
    fi
done

# Additional check: Warn about large files (might be transcripts/corpora)
LARGE_FILE_THRESHOLD=100000  # 100KB
while IFS= read -r file; do
    if [ -f "$file" ]; then
        filesize=$(wc -c < "$file")
        if [ "$filesize" -gt "$LARGE_FILE_THRESHOLD" ]; then
            echo "${YELLOW}‚ö†Ô∏è  WARNING: Large file detected: $file ($(numfmt --to=iec-i --suffix=B $filesize))${NC}"
            echo "   If this contains copyrighted material, it should be in data_private/"
            echo ""
        fi
    fi
done <<< "$STAGED_FILES"

# Check for suspicious content in text files
# Look for common copyright indicators in staged files
SUSPICIOUS_TERMS=("Copyright ¬©" "All rights reserved" "Transcript:" "TRANSCRIPT")
TEXT_EXTENSIONS=("txt" "md" "csv" "json")

while IFS= read -r file; do
    # Get file extension
    ext="${file##*.}"

    # Check if it's a text file we should scan
    if [[ " ${TEXT_EXTENSIONS[@]} " =~ " ${ext} " ]]; then
        if [ -f "$file" ]; then
            for term in "${SUSPICIOUS_TERMS[@]}"; do
                if grep -qi "$term" "$file"; then
                    echo "${YELLOW}‚ö†Ô∏è  WARNING: Suspicious content in $file${NC}"
                    echo "   Contains: '$term'"
                    echo "   Verify this is not copyrighted material before committing"
                    echo ""
                fi
            done
        fi
    fi
done <<< "$STAGED_FILES"

# If violations found, block the commit
if [ $VIOLATIONS_FOUND -eq 1 ]; then
    echo "${RED}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo "${RED}‚ïë  COMMIT BLOCKED - Copyright Protection                        ‚ïë${NC}"
    echo "${RED}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo "These files contain copyrighted material and must NOT be committed."
    echo ""
    echo "What to do:"
    echo "  1. Move these files to data_private/ (local only, gitignored)"
    echo "  2. Run: git reset HEAD <filename> to unstage them"
    echo "  3. Verify: git status (should not show these files)"
    echo ""
    echo "For more information, see:"
    echo "  - DATA_POLICY.md (complete copyright policy)"
    echo "  - data_private/README.md (what goes in private folder)"
    echo ""
    exit 1
fi

echo "${GREEN}‚úÖ No forbidden patterns detected - commit allowed${NC}"
echo ""
exit 0
